import os
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()  # важно: до чтения os.getenv

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
print("OPENAI_API_KEY in openai_service:", (OPENAI_API_KEY or "")[:8])

OPENAI_MODEL = "gpt-4o-mini"

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

SYSTEM_PROMPT = """
Ты — контент‑ассистент движения «5 вёрст».

ТВОЯ РОЛЬ:
- Помогаешь командам локальных мероприятий «5 вёрст» вести соцсети (VK и Telegram).
- Генерируешь тексты для постов, анонсов и отчётов о субботних встречах.
- Помогаешь объяснять формат «5 вёрст» новичкам и поддерживать дружескую атмосферу.
- Даёшь идеи по вовлечению участников и развитию локального сообщества.
- Помогаешь структурировать простой сбор данных об активности аудитории (чтение постов, реакции, комментарии) и предлагать направления для анализа.

ВАЖНО О «5 ВЁРСТ»:
- Это бесплатные еженедельные мероприятия на 5 км, проводимые силами волонтёров.
- Это НЕ соревнование и не тренировка, а дружеские субботние встречи: можно идти пешком или бежать в любом комфортном темпе, с коляской или в инвалидном кресле.
- Участники и волонтёры — главное в движении; важно показывать уважение, благодарность и инклюзивность.
- Keep it simple: простой, понятный, дружелюбный язык, минимум пафоса, максимум человечности.

ЧТО ДЕЛАТЬ НЕЛЬЗЯ:
- Не давать тренировочные планы, советы по нагрузкам, технике бега или подготовке к соревнованиям.
- Не называть «5 вёрст» тренировкой или соревнованием.
- Не давать медицинских рекомендаций или диагнозов.
- Не рекламировать платные товары/услуги без прямого запроса и пометки, что это реклама.
- Не копировать тексты дословно из внешних источников.

ФОРМАТ ДЛЯ ПОСТОВ:
- Короткий цепляющий заголовок (1 строка).
- 2–4 коротких абзаца основного текста.
- В конце — 1–2 понятных призыва к действию (записаться в волонтёры, прийти в субботу, поделиться фото, поставить реакцию).
- При необходимости — хэштеги #5вёрст и с указанием локации.
"""


async def _call_openai(user_content: str, max_tokens: int = 600, temperature: float = 0.7) -> str:
    """
    Вспомогательный вызов Chat Completions.
    Если ключа нет — возвращаем понятный текст вместо падения.
    """
    if not OPENAI_API_KEY:
        return (
            "[ТЕСТОВЫЙ РЕЖИМ БЕЗ OPENAI]\n\n"
            "OPENAI_API_KEY не найден. Проверь файл .env и перезапусти бота."
        )

    response = await client.chat.completions.create(
        model=OPENAI_MODEL,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_content},
        ],
        temperature=temperature,
        max_tokens=max_tokens,
    )
    return response.choices[0].message.content.strip()


async def generate_post(
    topic: str,
    post_type: str = "announcement",
    platform: str = "telegram",
) -> str:
    """
    Генерация поста для /create_post и кнопок.
    post_type: volunteer_call | event_announcement | event_report | community_story | info | announcement
    platform: telegram | vk
    """
    type_map = {
        "volunteer_call": "пост-набор волонтёров",
        "event_announcement": "анонс субботнего мероприятия или праздника",
        "event_report": "короткий отчёт о том, как всё прошло",
        "community_story": "история участника, волонтёра или локации",
        "info": "информационный пост о формате 5 вёрст",
        "announcement": "анонс субботней встречи 5 вёрст",
    }

    platform_hint = (
        "для Telegram: короче, структурировано, можно использовать эмодзи"
        if platform == "telegram"
        else "для ВКонтакте: можно писать чуть подробнее, добавить вопросы и приглашение к комментариям"
    )

    user_content = (
        f"Нужно написать {type_map.get(post_type, 'пост для сообщества 5 вёрст')}.\n"
        f"Площадка: {platform}. Подсказка по стилю: {platform_hint}.\n\n"
        f"Тема/контекст: {topic}\n\n"
        "Соблюдай формат: заголовок, 2–4 абзаца текста, в конце 1–2 призыва к действию."
    )

    max_tokens = 400 if platform == "telegram" else 800
    return await _call_openai(user_content, max_tokens=max_tokens, temperature=0.7)


async def answer_question(question: str) -> str:
    """
    Ответы для /ask — про формулировки, тексты, соцсети, вовлечение, простые метрики.
    """
    user_content = (
        "Ответь на вопрос организатора/волонтёра движения 5 вёрст.\n"
        "Вопрос может касаться формулировок постов, описаний групп, рубрик, вовлечения, простого анализа активности.\n"
        "Дай структурированный ответ (пункты, чек-лист, примеры формулировок), без тренировочных и медицинских советов.\n\n"
        f"Вопрос: {question}"
    )

    return await _call_openai(user_content, max_tokens=800, temperature=0.6)


async def adapt_for_platform(content: str, target_platform: str = "vk") -> str:
    """
    Адаптация существующего текста под VK или лёгкий рефакторинг.
    """
    if target_platform == "vk":
        instruction = (
            "Адаптируй этот текст под формат поста ВКонтакте для сообщества 5 вёрст.\n"
            "Можно сделать текст немного длиннее, добавить вопросы к аудитории и мягкие приглашения "
            "оставить комментарий, поделиться фото, отметить друзей.\n"
            "Сохрани тон: дружелюбный, простой, без спортивного пафоса.\n"
            "Не добавляй тренировочных советов и не превращай это в соревнование.\n\n"
            f"Исходный текст:\n{content}"
        )
    else:
        instruction = (
            "Немного улучшите и отредактируйте этот текст, сохранив стиль движения 5 вёрст.\n\n"
            f"Текст:\n{content}"
        )

    return await _call_openai(instruction, max_tokens=800, temperature=0.6)
